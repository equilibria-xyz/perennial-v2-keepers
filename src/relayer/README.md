# Description

[Perennial Collateral Accounts](https://github.com/equilibria-xyz/perennial-v2/blob/v2.3/packages%2Fperennial-account%2FREADME.md) use intents to improve trading experience. Intents are EIP-712 message payloads submitted to this keeper which are then sponsored through a paymaster, allowing gasless trading.

# Intents

Supported intents include

```
  [
    `DeployAccount`,
    `MarketTransfer`,
    `Withdrawal`,
    `RebalanceConfigChange`


    // Relayed intents
    `RelayedNonceCancellation`,
    `RelayedGroupCancellation`,
    `RelayedSignerUpdate`,
    `RelayedOperatorUpdate`,
    `RelayedAccessUpdateBatch`
  ]
```

Relayed intents reward relayers for forwarding transactions.

# Env
There are several environment variables that can be adjusted if performance expectations are not being met.
- GAS_LIMIT_MULTIPLIER: defaults to 1.5. Applys a multiplier to the Alchemy's estimated call gas limit
- TIP_MULTIPLIER: defaults to 1.3. Applys a multiplier to the Alchemy's maxFeePerGas and maxPriorityFeePerGas
- TIP_PERCENTAGE_INCREASE: defaults to 0.1. Each retry replacement userOps must increas `maxFeePerGas` and `maxPriorityFeePerGas` by a minimum of 10%. This is a min limit set by alchemy and building sent userOps will get rejected if this limit is not met.
- RELAYER_MAX_RETRY: defaults to 3. The default number of times the relayer will retry `build` -> `sign` -> `send` a userOp. Only certain errors will be retried, these are set in `RetryOnErrors` found in `perennial-v2-keepers/src/utils/relayerUtils`. Reverted inner userOps will not get retried.

# Routes

## POST `/relayIntent`

### Body Args

```
    {
      intents: {
        signatures: Hex[]; // required
        signingPayload: SigningPayload, // required
      }[], // required
      meta?: {
        wait?: boolean // optional
        maxRetries?: number // optional
      } // optional
    }
```

#### Meta

- `wait` if you want to wait for the transaction receipt. If `wait` is used then the return type will include the transaction hash.
- `maxRetries` controls how many times the relayer will try to relay the userOp, will override the ENV variable RELAYER_MAX_RETRY

#### Signatures

If Intent is one of `DeployAccount`, `MarketTransfer`, `Withdrawal`, `RebalanceConfigChange` then only one `signature` is required.

If Intent is one of `RelayedNonceCancellation`, `RelayedGroupCancellation`, `RelayedSignerUpdate`, `RelayedOperatorUpdate`, `RelayedAccessUpdateBatch` then both `innerSignature` and `outerSignature` are required.

#### Payload

`signingPayload` can be generated by the sdk, manually or by calling `/genSig`.

### Returns

```
  success: boolean,
  status: UserOpStatus, // 'complete' | 'pending' | 'failed'
  uoHash: Hex, // userOperation hash
  txHash: Hex // Optional, will be set if the using `meta.wait`
```

The user operation hash. Can be passed into `/status` to get the operations receipt. When not using `meta.wait` the tx is unconfirmed, hence returning `UserOpStatus.Pending`.

## GET `/status`

### Query Args

```
  {
    hash: Hex; // required
  }
```

### Returns

The user operation receipt